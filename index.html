<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ’œ ë‹¤ë¦°í¬ë˜í”„íŠ¸ ììˆ˜ ë„ì•ˆ ë©”ì´ì»¤</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        /* ê¸°ë³¸ í…Œë§ˆ ì„¤ì • */
        :root {
            --primary: #9e7bb5;
            --primary-light: #c7a4d6;
            --primary-dark: #8e62a8;
            --bg-color: #f4ebf8;
            --panel-bg: #ffffff;
            --text-main: #4a3b52;
            --text-muted: #887a8f;
            --border-color: #d5b8e0;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
        }

        h1 {
            color: var(--primary-dark);
            margin-bottom: 25px;
            font-weight: 700;
            letter-spacing: -0.5px;
            text-shadow: 1px 1px 2px rgba(142, 98, 168, 0.15);
            text-align: center;
        }

        /* --- ìƒë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ --- */
        .controls {
            background-color: var(--panel-bg);
            padding: 20px 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(142, 98, 168, 0.08);
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            width: 100%;
            max-width: 1200px; 
            box-sizing: border-box;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        input[type="file"] {
            display: none;
        }
        
        .file-upload-label {
            background-color: var(--bg-color);
            color: var(--primary-dark);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 14px;
            text-align: center;
        }

        .file-upload-label:hover {
            background-color: #ebd9f2;
        }

        #fileName {
            font-size: 14px;
            color: var(--text-muted);
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        input[type="number"] {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            outline: none;
            color: var(--text-main);
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(158, 123, 181, 0.1);
        }
        
        input[type="checkbox"] {
            accent-color: var(--primary);
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* ë²„íŠ¼ ê³µí†µ ë””ìì¸ */
        button {
            font-family: inherit;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            box-sizing: border-box;
        }

        button.primary-btn {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
            border: none;
            padding: 10px 24px;
            font-size: 15px;
            margin-left: auto;
            box-shadow: 0 4px 10px rgba(158, 123, 181, 0.3);
        }

        button.primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(158, 123, 181, 0.4);
        }

        button.toggle-btn {
            background-color: white;
            color: var(--primary-dark);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            font-size: 14px;
        }

        button.toggle-btn:hover {
            background-color: var(--bg-color);
        }

        button.toggle-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* --- ë©”ì¸ ë ˆì´ì•„ì›ƒ --- */
        .main-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            width: 100%;
            max-width: 1200px;
            box-sizing: border-box;
        }

        /* ì™¼ìª½ ìº”ë²„ìŠ¤ ì˜ì—­ */
        .canvas-container {
            flex: 1;
            background-color: var(--panel-bg);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(142, 98, 168, 0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 400px;
            min-width: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .canvas-toolbar {
            width: 100%;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--bg-color);
            padding-bottom: 15px;
        }

        .canvas-wrapper {
            width: 100%;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex: 1;
        }

        #resultCanvas {
            max-width: 100%;
            height: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: max-width 0.3s ease;
            border: 1px solid #eee;
        }

        #resultCanvas.zoomed-in {
            max-width: none;
        }

        /* ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” */
        .legend-wrapper {
            width: 300px; /* PC ê¸°ë³¸ ë„ˆë¹„ */
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-shrink: 0;
        }

        .legend-wrapper.closed {
            width: 130px; /* PCì—ì„œ ë‹«í˜”ì„ ë•Œ ë„ˆë¹„ */
        }

        .legend-container {
            background-color: var(--panel-bg);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(142, 98, 168, 0.08);
            max-height: 80vh;
            overflow-y: auto;
        }

        .legend-container h2 {
            color: var(--primary-dark);
            margin-top: 0;
            font-size: 1.1rem;
            font-weight: 700;
            border-bottom: 2px dashed var(--border-color);
            padding-bottom: 12px;
            margin-bottom: 15px;
        }

        .color-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 6px 8px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .color-item:hover {
            background-color: var(--bg-color);
        }

        .color-box {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.1);
            margin-right: 12px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }

        .color-info {
            font-size: 14px;
            font-weight: 500;
            line-height: 1.3;
        }

        .color-no {
            font-weight: 700;
            color: var(--primary);
            margin-right: 6px;
            display: inline-block;
            min-width: 35px;
        }
        
        .color-eng {
            font-size: 12px;
            color: var(--text-muted);
            display: block;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-canvas { animation: slideUpFade 0.5s ease forwards; }
        .animate-sidebar { animation: slideUpFade 0.5s ease forwards; }

        /* ========================================================= */
        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ë””ìì¸ (í™”ë©´ ë„ˆë¹„ 768px ì´í•˜ì¼ ë•Œ ì ìš©) */
        /* ========================================================= */
        @media (max-width: 768px) {
            body {
                padding: 15px 10px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .controls {
                flex-direction: column; /* ì„¸ë¡œ ë°°ì¹˜ */
                align-items: stretch;
                padding: 15px;
                gap: 12px;
            }

            .control-group {
                width: 100%;
                justify-content: space-between; /* ì–‘ìª½ ì •ë ¬ */
            }

            #fileName {
                max-width: 40%;
                text-align: right;
            }

            button.primary-btn {
                margin-left: 0;
                width: 100%;
                padding: 12px;
                margin-top: 5px;
            }

            .main-container {
                flex-direction: column; /* ë„ì•ˆ ë°‘ì— ì»¬ëŸ¬ ëª©ë¡ ì˜¤ë„ë¡ ì„¸ë¡œ ë°°ì¹˜ */
            }

            .canvas-container {
                padding: 15px;
                min-height: 300px;
            }

            .canvas-toolbar {
                flex-wrap: wrap; /* ë²„íŠ¼ì´ ë§ìœ¼ë©´ ë‹¤ìŒ ì¤„ë¡œ ë„˜ì–´ê°€ë„ë¡ */
                justify-content: center;
            }

            .canvas-toolbar button {
                flex: 1 1 30%; /* ë²„íŠ¼ì´ ê³µê°„ì„ ê³ ë¥´ê²Œ ì°¨ì§€í•˜ë„ë¡ */
                font-size: 13px;
                padding: 8px 5px;
            }

            /* ëª¨ë°”ì¼ì—ì„  ë²”ë¡€ ë„ˆë¹„ë¥¼ 100%ë¡œ ë³€ê²½ */
            .legend-wrapper, .legend-wrapper.closed {
                width: 100%; 
            }

            .legend-container {
                max-height: 50vh; /* ëª¨ë°”ì¼ì—ì„œëŠ” ë†’ì´ë¥¼ ì¡°ê¸ˆ ì¤„ì„ */
            }
        }
    </style>
</head>
<body>

    <h1>ğŸ’œ ììˆ˜ ë„ì•ˆ ë©”ì´ì»¤</h1>
    
    <div class="controls">
        <div class="control-group">
            <label class="file-upload-label">
                ğŸ“ ì´ë¯¸ì§€ ì„ íƒ
                <input type="file" id="imageInput" accept="image/*" onchange="updateFileName()">
            </label>
            <span id="fileName">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
        </div>

        <div class="control-group">
            <label>ğŸ“ ê°€ë¡œ ê²©ì:</label>
            <input type="number" id="gridSize" value="40" min="10" max="200" style="width: 70px;">
        </div>
        
        <div class="control-group" style="background-color: var(--bg-color); padding: 8px 12px; border-radius: 8px;">
            <label style="cursor: pointer; display: flex; align-items: center; gap: 6px; width: 100%;">
                <input type="checkbox" id="limitColorsCheck" onchange="toggleColorLimitInput()"> 
                ì»¬ëŸ¬ ìˆ˜ ì œí•œ
            </label>
            <span id="colorLimitWrapper" style="display: none; white-space: nowrap;">
                <input type="number" id="colorLimit" value="15" min="5" max="145" style="width: 50px;"> ê°œ
            </span>
        </div>

        <button class="primary-btn" onclick="processImage()">ë„ì•ˆ ìƒì„±í•˜ê¸° âœ¨</button>
    </div>

    <div class="main-container">
        <div class="canvas-container" id="canvasContainer">
            <div class="canvas-toolbar" id="canvasToolbar" style="display: none;">
                <button class="toggle-btn" id="originalViewBtn" onclick="toggleOriginalView()">ğŸ–¼ï¸ ì›ë³¸ ë³´ê¸°</button>
                <button class="toggle-btn" id="numberBtn" onclick="toggleNumbers()">ğŸ”¢ ë²ˆí˜¸ ë„ê¸°</button>
                <button class="toggle-btn" id="zoomBtn" onclick="toggleZoom()">ğŸ” í™•ëŒ€ ë³´ê¸°</button>
            </div>
            
            <p id="placeholder" style="color:var(--text-muted); text-align:center; margin-top:100px; font-weight: 500;">
                ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ìƒì„± ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš” ğŸ¨
            </p>
            
            <div class="canvas-wrapper">
                <canvas id="resultCanvas" style="display: none;"></canvas>
            </div>
        </div>

        <div class="legend-wrapper" id="legendWrapper" style="display: none;">
            <button class="toggle-btn" id="toggleLegendBtn" onclick="toggleLegend()" style="width: 100%; text-align: center; border-color: transparent; background-color: var(--bg-color);">
                ğŸ¨ ì»¬ëŸ¬ ëª©ë¡ ë‹«ê¸°
            </button>
            <div class="legend-container" id="legendContainer">
                <h2>ğŸ¨ ì‚¬ìš©ëœ ì»¬ëŸ¬ (<span id="colorCount">0</span>ê°œ)</h2>
                <div id="colorList"></div>
            </div>
        </div>
    </div>

    <script>
        // 145ë²ˆê¹Œì§€ì˜ í’€ ë°ì´í„°ë² ì´ìŠ¤
        const darinThreads = [
            {no: 1, rgb: [255, 255, 255], hex: "#FFFFFF", eng: "Pure White", name: "ìˆœë°±ìƒ‰"},
            {no: 2, rgb: [191, 149, 255], hex: "#BF95FF", eng: "Light Lavender", name: "ì—°ë¼ë²¤ë”"},
            {no: 3, rgb: [170, 85, 254], hex: "#AA55FE", eng: "Medium Purple", name: "ì¤‘ê°„ ë³´ë¼"},
            {no: 4, rgb: [106, 21, 170], hex: "#6A15AA", eng: "Deep Violet", name: "ì§„ë³´ë¼"},
            {no: 5, rgb: [85, 21, 128], hex: "#551580", eng: "Dark Purple", name: "ì§„í¬ë„ìƒ‰"},
            {no: 6, rgb: [128, 85, 191], hex: "#8055BF", eng: "Amethyst", name: "ììˆ˜ì •ìƒ‰"},
            {no: 7, rgb: [64, 0, 149], hex: "#400095", eng: "Deep Indigo", name: "ì§„ë‚¨ìƒ‰"},
            {no: 8, rgb: [106, 64, 106], hex: "#6A406A", eng: "Plum Gray", name: "ìë‘ íšŒìƒ‰"},
            {no: 9, rgb: [0, 254, 254], hex: "#00FEFE", eng: "Cyan", name: "ì²­ë¡ìƒ‰"},
            {no: 10, rgb: [21, 170, 212], hex: "#15AAD4", eng: "Sky Blue", name: "ìŠ¤ì¹´ì´ ë¸”ë£¨"},
            {no: 11, rgb: [0, 170, 170], hex: "#00AAAA", eng: "Dark Teal", name: "ë‹¤í¬ í‹¸"},
            {no: 12, rgb: [255, 254, 254], hex: "#FFFEFE", eng: "Soft White", name: "ì†Œí”„íŠ¸ í™”ì´íŠ¸"},
            {no: 13, rgb: [255, 212, 212], hex: "#FFD4D4", eng: "Pale Pink", name: "ì—°ë¶„í™ìƒ‰"},
            {no: 14, rgb: [255, 149, 191], hex: "#FF95BF", eng: "Bubblegum Pink", name: "ì§„í•œ ë¶„í™"},
            {no: 15, rgb: [254, 128, 170], hex: "#FE80AA", eng: "Rose Pink", name: "ì¥ë¯¸ ë¶„í™"},
            {no: 16, rgb: [255, 149, 212], hex: "#FF95D4", eng: "Orchid Pink", name: "ì˜¤í‚¤ë“œ í•‘í¬"},
            {no: 17, rgb: [255, 64, 212], hex: "#FF40D4", eng: "Hot Pink", name: "í•« í•‘í¬"},
            {no: 18, rgb: [212, 85, 149], hex: "#D45595", eng: "Raspberry", name: "ì‚°ë”¸ê¸°ìƒ‰"},
            {no: 19, rgb: [212, 21, 128], hex: "#D41580", eng: "Magenta", name: "ë§ˆì  íƒ€"},
            {no: 20, rgb: [170, 42, 106], hex: "#AA2A6A", eng: "Burgundy Pink", name: "ìì£¼ìƒ‰"},
            {no: 21, rgb: [212, 170, 191], hex: "#D4AABF", eng: "Ash Pink", name: "ì• ì‰¬ í•‘í¬"},
            {no: 22, rgb: [149, 85, 128], hex: "#955580", eng: "Antique Rose", name: "ì—”í‹± ë¡œì¦ˆ"},
            {no: 23, rgb: [85, 0, 64], hex: "#550040", eng: "Dark Wine", name: "ì§„ì™€ì¸ìƒ‰"},
            {no: 24, rgb: [255, 255, 212], hex: "#FFFFD4", eng: "Cream", name: "í¬ë¦¼ìƒ‰"},
            {no: 25, rgb: [255, 254, 149], hex: "#FFFE95", eng: "Pastel Yellow", name: "íŒŒìŠ¤í…” ë…¸ë‘"},
            {no: 26, rgb: [191, 254, 170], hex: "#BFFEAA", eng: "Mint Green", name: "ë¯¼íŠ¸ ê·¸ë¦°"},
            {no: 27, rgb: [255, 254, 212], hex: "#FFFED4", eng: "Ivory White", name: "ì•„ì´ë³´ë¦¬ í™”ì´íŠ¸"},
            {no: 28, rgb: [254, 212, 191], hex: "#FED4BF", eng: "Apricot", name: "ì‚´êµ¬ìƒ‰"},
            {no: 29, rgb: [254, 170, 170], hex: "#FEAAAA", eng: "Coral Pink", name: "ì½”ë„ í•‘í¬"},
            {no: 30, rgb: [149, 0, 0], hex: "#950000", eng: "Pure Red", name: "ì§„ë¹¨ê°•"},
            {no: 31, rgb: [128, 42, 42], hex: "#802A2A", eng: "Russet", name: "ê°ˆì ìƒ‰"},
            {no: 32, rgb: [128, 0, 0], hex: "#800000", eng: "Maroon", name: "ë§ˆë£¬"},
            {no: 33, rgb: [106, 0, 0], hex: "#6A0000", eng: "Dark Red", name: "ì–´ë‘ìš´ ë¹¨ê°•"},
            {no: 34, rgb: [64, 0, 64], hex: "#400040", eng: "Dark Deep Purple", name: "ë§¤ìš° ì–´ë‘ìš´ ë³´ë¼"},
            {no: 35, rgb: [212, 254, 255], hex: "#D4FEFF", eng: "Pale Blue", name: "ì—°í•˜ëŠ˜ìƒ‰"},
            {no: 36, rgb: [128, 191, 255], hex: "#80BFFF", eng: "Azure", name: "ë‹´ì²­ìƒ‰"},
            {no: 37, rgb: [42, 191, 255], hex: "#2ABFFF", eng: "Bright Sky Blue", name: "ë°ì€ í•˜ëŠ˜ìƒ‰"},
            {no: 38, rgb: [64, 149, 255], hex: "#4095FF", eng: "Cornflower Blue", name: "ìˆ˜ë ˆêµ­í™”ìƒ‰"},
            {no: 39, rgb: [21, 106, 212], hex: "#156AD4", eng: "Royal Blue", name: "ë¡œì—´ ë¸”ë£¨"},
            {no: 40, rgb: [0, 85, 191], hex: "#0055BF", eng: "Ocean Blue", name: "ê¹Šì€ ë°”ë‹¤ìƒ‰"},
            {no: 41, rgb: [42, 64, 128], hex: "#2A4080", eng: "Denim Blue", name: "ë°ë‹˜ ë¸”ë£¨"},
            {no: 42, rgb: [42, 64, 85], hex: "#2A4055", eng: "Steel Blue", name: "ìŠ¤í‹¸ ë¸”ë£¨"},
            {no: 43, rgb: [0, 0, 42], hex: "#00002A", eng: "Midnight Blue", name: "ë¯¸ë“œë‚˜ì‡ ë¸”ë£¨"},
            {no: 44, rgb: [85, 218, 170], hex: "#55DAAA", eng: "Seafoam Green", name: "ê±°í’ˆ ë°”ë‹¤ìƒ‰"},
            {no: 45, rgb: [106, 128, 149], hex: "#6A8095", eng: "Slate Gray Blue", name: "ìŠ¬ë ˆì´íŠ¸ ê·¸ë ˆì´"},
            {no: 46, rgb: [64, 106, 128], hex: "#406A80", eng: "Muted Teal", name: "ì°¨ë¶„í•œ í‹¸"},
            {no: 47, rgb: [85, 85, 106], hex: "#55556A", eng: "Dusky Blue", name: "ì–´ìŠ¤ë¦„í•œ ì²­ìƒ‰"},
            {no: 48, rgb: [42, 42, 85], hex: "#2A2A55", eng: "Dark Navy", name: "ì§„ë‚¨ìƒ‰"},
            {no: 49, rgb: [21, 21, 64], hex: "#151540", eng: "Deep Navy", name: "ë§¤ìš° ì–´ë‘ìš´ ë‚¨ìƒ‰"},
            {no: 50, rgb: [64, 0, 212], hex: "#4000D4", eng: "Vivid Violet", name: "ì„ ëª…í•œ ì œë¹„ê½ƒìƒ‰"},
            {no: 51, rgb: [42, 42, 128], hex: "#2A2A80", eng: "Deep Blue", name: "ì§„ì²­ìƒ‰"},
            {no: 52, rgb: [21, 170, 64], hex: "#15AA40", eng: "Grass Green", name: "í’€ìƒ‰"},
            {no: 53, rgb: [0, 149, 64], hex: "#009540", eng: "Forest Green", name: "ìˆ²ìƒ‰"},
            {no: 54, rgb: [128, 149, 85], hex: "#809555", eng: "Olive Green", name: "ì˜¬ë¦¬ë¸Œ ê·¸ë¦°"},
            {no: 55, rgb: [85, 106, 42], hex: "#556A2A", eng: "Moss Green", name: "ì´ë¼ìƒ‰"},
            {no: 56, rgb: [42, 85, 42], hex: "#2A552A", eng: "Dark Forest", name: "ì§„í•œ ìˆ²ìƒ‰"},
            {no: 57, rgb: [21, 64, 21], hex: "#154015", eng: "Hunter Green", name: "í—Œí„° ê·¸ë¦°"},
            {no: 58, rgb: [0, 170, 64], hex: "#00AA40", eng: "Emerald Green", name: "ì—ë©”ë„ë“œ ê·¸ë¦°"},
            {no: 59, rgb: [42, 106, 64], hex: "#2A6A40", eng: "Pine Green", name: "ì†Œë‚˜ë¬´ìƒ‰"},
            {no: 60, rgb: [254, 254, 191], hex: "#FEFED4", eng: "Pale Lemon", name: "ì—°ë…¸ë‘ìƒ‰"},
            {no: 61, rgb: [106, 106, 85], hex: "#6A6A55", eng: "Khaki", name: "ì¹´í‚¤ìƒ‰"},
            {no: 62, rgb: [106, 106, 64], hex: "#6A6A40", eng: "Olive Brown", name: "ì˜¬ë¦¬ë¸Œ ê°ˆìƒ‰"},
            {no: 63, rgb: [255, 106, 85], hex: "#FF6A55", eng: "Vermilion", name: "ì£¼í™©ë¹› ë¹¨ê°•"},
            {no: 64, rgb: [255, 106, 0], hex: "#FF6A00", eng: "Bright Orange", name: "ì„ ëª…í•œ ì£¼í™©"},
            {no: 65, rgb: [255, 64, 42], hex: "#FF402A", eng: "Scarlet", name: "ë‹¤í™ìƒ‰"},
            {no: 66, rgb: [254, 0, 0], hex: "#FE0000", eng: "Vivid Red", name: "ì„ ëª…í•œ ë¹¨ê°•"},
            {no: 67, rgb: [212, 21, 0], hex: "#D41500", eng: "Brick Red", name: "ë²½ëŒìƒ‰"},
            {no: 68, rgb: [212, 0, 0], hex: "#D40000", eng: "Classic Red", name: "í´ë˜ì‹ ë ˆë“œ"},
            {no: 69, rgb: [170, 0, 0], hex: "#AA0000", eng: "Dark Brick", name: "ì–´ë‘ìš´ ë²½ëŒìƒ‰"},
            {no: 70, rgb: [212, 212, 212], hex: "#D4D4D4", eng: "Light Gray", name: "ë°ì€ íšŒìƒ‰"},
            {no: 71, rgb: [170, 170, 170], hex: "#AAAAAA", eng: "Silver", name: "ì€íšŒìƒ‰"},
            {no: 72, rgb: [85, 85, 85], hex: "#555555", eng: "Medium Gray", name: "ì¤‘ê°„ íšŒìƒ‰"},
            {no: 73, rgb: [149, 149, 149], hex: "#959595", eng: "Cool Gray", name: "ì¿¨ ê·¸ë ˆì´"},
            {no: 74, rgb: [106, 106, 106], hex: "#6A6A6A", eng: "Slate Gray", name: "ìŠ¬ë ˆì´íŠ¸ ê·¸ë ˆì´"},
            {no: 75, rgb: [64, 64, 64], hex: "#404040", eng: "Charcoal", name: "ì°¨ì½œ"},
            {no: 76, rgb: [255, 255, 154], hex: "#FFFF9A", eng: "Lemon Chiffon", name: "ë ˆëª¬ ì‰¬í°"},
            {no: 77, rgb: [254, 254, 212], hex: "#FEFED4", eng: "Antique White", name: "ì—”í‹± í™”ì´íŠ¸"},
            {no: 78, rgb: [212, 170, 149], hex: "#D4AAB5", eng: "Rosy Brown", name: "ì¥ë¯¸ë¹› ê°ˆìƒ‰"},
            {no: 79, rgb: [254, 254, 254], hex: "#FEFEFE", eng: "Ghost White", name: "ê³ ìŠ¤íŠ¸ í™”ì´íŠ¸"},
            {no: 80, rgb: [21, 212, 191], hex: "#15D4BF", eng: "Turquoise", name: "í„°ì¿¼ì´ì¦ˆ"},
            {no: 81, rgb: [212, 191, 170], hex: "#D4BFAB", eng: "Sand Beige", name: "ëª¨ë˜ìƒ‰ ë² ì´ì§€"},
            {no: 82, rgb: [254, 212, 149], hex: "#FED495", eng: "Peach", name: "ë³µìˆ­ì•„ìƒ‰"},
            {no: 83, rgb: [191, 170, 128], hex: "#BFAA80", eng: "Tan", name: "í™©ê°ˆìƒ‰"},
            {no: 84, rgb: [254, 170, 42], hex: "#FEAA2A", eng: "Orange Gold", name: "ì£¼í™©ë¹› ê¸ˆìƒ‰"},
            {no: 85, rgb: [254, 149, 42], hex: "#FE952A", eng: "Amber", name: "í˜¸ë°•ìƒ‰"},
            {no: 86, rgb: [212, 149, 0], hex: "#D49500", eng: "Goldenrod", name: "ê¸ˆí™ìƒ‰"},
            {no: 87, rgb: [255, 254, 21], hex: "#FFFE15", eng: "Yellow", name: "ë…¸ë€ìƒ‰"},
            {no: 88, rgb: [255, 212, 0], hex: "#FFD400", eng: "Deep Yellow", name: "ì§„ë…¸ë‘"},
            {no: 89, rgb: [255, 170, 0], hex: "#FF9500", eng: "Chrome Orange", name: "í¬ë¡¬ ì£¼í™©"},
            {no: 90, rgb: [254, 106, 0], hex: "#FE6A00", eng: "Cadmium Orange", name: "ì¹´ë“œë®´ ì£¼í™©"},
            {no: 91, rgb: [255, 254, 0], hex: "#FFFE00", eng: "Neon Yellow", name: "í˜•ê´‘ ë…¸ë‘"},
            {no: 92, rgb: [254, 149, 21], hex: "#FE9515", eng: "Pumpkin", name: "í˜¸ë°• ì£¼í™©"},
            {no: 93, rgb: [191, 106, 42], hex: "#BF6A2A", eng: "Sienna", name: "ì‹œì—ë‚˜"},
            {no: 94, rgb: [191, 85, 64], hex: "#BF5540", eng: "Terracotta", name: "í…Œë¼ì½”íƒ€"},
            {no: 95, rgb: [191, 64, 0], hex: "#BF4000", eng: "Rust", name: "ë…¹ìŠ¨ ì£¼í™©"},
            {no: 96, rgb: [149, 106, 64], hex: "#956A40", eng: "Ochre", name: "í™©í† ìƒ‰"},
            {no: 97, rgb: [149, 85, 0], hex: "#955500", eng: "Brown", name: "ê°ˆìƒ‰"},
            {no: 98, rgb: [106, 42, 21], hex: "#6A2A15", eng: "Chocolate", name: "ì´ˆì½œë¦¿ìƒ‰"},
            {no: 99, rgb: [85, 21, 0], hex: "#551500", eng: "Espresso", name: "ì—ìŠ¤í”„ë ˆì†Œ"},
            {no: 100, rgb: [191, 149, 106], hex: "#BF956A", eng: "Camel", name: "ì¹´ë©œìƒ‰"},
            {no: 101, rgb: [149, 128, 106], hex: "#95806A", eng: "Taupe", name: "íšŒê°ˆìƒ‰"},
            {no: 102, rgb: [128, 85, 64], hex: "#805540", eng: "Coffee", name: "ì»¤í”¼ìƒ‰"},
            {no: 103, rgb: [85, 42, 21], hex: "#552A15", eng: "Dark Chocolate", name: "ë‹¤í¬ ì´ˆì½œë¦¿"},
            {no: 104, rgb: [128, 106, 85], hex: "#806A55", eng: "Walnut", name: "í˜¸ë‘ìƒ‰"},
            {no: 105, rgb: [85, 21, 21], hex: "#551515", eng: "Deep Brown", name: "ì§„ê°ˆìƒ‰"},
            {no: 106, rgb: [128, 106, 64], hex: "#806A40", eng: "Bronze", name: "ì²­ë™ìƒ‰"},
            {no: 107, rgb: [64, 42, 21], hex: "#402A15", eng: "Dark Wood", name: "ê³ ëª©ìƒ‰"},
            {no: 108, rgb: [42, 0, 0], hex: "#2A0000", eng: "Black Brown", name: "í‘ê°ˆìƒ‰"},
            {no: 109, rgb: [212, 106, 85], hex: "#D46A55", eng: "Burnt Sienna", name: "íƒ€ë²„ë¦° ì‹œì—ë‚˜"},
            {no: 110, rgb: [170, 149, 0], hex: "#AA9500", eng: "Mustard", name: "ë¨¸ìŠ¤í„°ë“œ"},
            {no: 111, rgb: [128, 170, 41], hex: "#80AA29", eng: "Sap Green", name: "ìˆ˜ì•¡ ë…¹ìƒ‰"},
            {no: 112, rgb: [255, 64, 128], hex: "#FF4080", eng: "Rose Red", name: "ì¥ë¯¸ ë¹¨ê°•"},
            {no: 113, rgb: [42, 254, 0], hex: "#2AFE00", eng: "Lime Green", name: "ë¼ì„ ê·¸ë¦°"},
            {no: 114, rgb: [191, 255, 21], hex: "#BFFF15", eng: "Chartreuse", name: "ì—°ë‘ìƒ‰"},
            {no: 115, rgb: [191, 191, 191], hex: "#BFBFBF", eng: "Ash Gray", name: "ì• ì‰¬ ê·¸ë ˆì´"},
            {no: 116, rgb: [128, 128, 128], hex: "#808080", eng: "Smoke Gray", name: "ì—°ê¸°ìƒ‰ íšŒìƒ‰"},
            {no: 117, rgb: [42, 42, 42], hex: "#2A2A2A", eng: "Graphite", name: "í‘ì—°ìƒ‰"},
            {no: 118, rgb: [255, 255, 245], hex: "#FFFFF5", eng: "Off-white", name: "ì˜¤í”„ í™”ì´íŠ¸"},
            {no: 119, rgb: [0, 0, 0], hex: "#000000", eng: "Pure Black", name: "ìˆœê²€ì •"},
            {no: 120, rgb: null, hex: "-", eng: "Special Yarn", name: "íŠ¹ìˆ˜ì‚¬"},
            {no: 121, rgb: [255, 212, 149], hex: "#FFD495", eng: "Light Peach", name: "ë°ì€ ë³µìˆ­ì•„ìƒ‰"},
            {no: 122, rgb: [254, 191, 128], hex: "#FEBF80", eng: "Apricot Orange", name: "ì‚´êµ¬ ì£¼í™©"},
            {no: 123, rgb: [212, 170, 85], hex: "#D4AA55", eng: "Golden Brown", name: "í™©ê¸ˆ ê°ˆìƒ‰"},
            {no: 124, rgb: [255, 170, 128], hex: "#FFAA80", eng: "Salmon Pink", name: "ì—°ì–´ìƒ‰ ë¶„í™"},
            {no: 125, rgb: [255, 128, 128], hex: "#FF8080", eng: "Coral Red", name: "ì½”ë„ ë ˆë“œ"},
            {no: 126, rgb: [254, 254, 21], hex: "#FEFE15", eng: "Bright Yellow", name: "ë°ì€ ë…¸ë‘"},
            {no: 127, rgb: [170, 191, 21], hex: "#AABF15", eng: "Pear Green", name: "ë°°ìƒ‰ ë…¹ìƒ‰"},
            {no: 128, rgb: [149, 128, 0], hex: "#958000", eng: "Olive", name: "ì˜¬ë¦¬ë¸Œ"},
            {no: 129, rgb: [255, 191, 255], hex: "#FFBFFF", eng: "Pink Lavender", name: "í•‘í¬ ë¼ë²¤ë”"},
            {no: 130, rgb: [21, 149, 128], hex: "#159580", eng: "Pine", name: "ì†Œë‚˜ë¬´ ë…¹ìƒ‰"},
            {no: 131, rgb: [254, 170, 85], hex: "#FEAA55", eng: "Orange Sorbet", name: "ì˜¤ë Œì§€ ìƒ¤ë² íŠ¸"},
            {no: 132, rgb: [170, 106, 21], hex: "#AA6A15", eng: "Copper", name: "êµ¬ë¦¬ìƒ‰"},
            {no: 133, rgb: [0, 212, 149], hex: "#00D495", eng: "Spring Green", name: "ìŠ¤í”„ë§ ê·¸ë¦°"},
            {no: 134, rgb: [212, 149, 128], hex: "#D49580", eng: "Sandy Brown", name: "ëª¨ë˜ë¹› ê°ˆìƒ‰"},
            {no: 135, rgb: [191, 128, 106], hex: "#BF806A", eng: "Wood Brown", name: "ë‚˜ë¬´ìƒ‰ ê°ˆìƒ‰"},
            {no: 136, rgb: [128, 64, 21], hex: "#804015", eng: "Cinnamon", name: "ì‹œë‚˜ëª¬"},
            {no: 137, rgb: [191, 149, 128], hex: "#BF9580", eng: "Beige Brown", name: "ë² ì´ì§€ ê°ˆìƒ‰"},
            {no: 138, rgb: [149, 106, 85], hex: "#956A55", eng: "Mud Brown", name: "ì§„í™ ê°ˆìƒ‰"},
            {no: 139, rgb: [170, 106, 85], hex: "#AA6A55", eng: "Clay", name: "ì í† ìƒ‰"},
            {no: 140, rgb: [191, 106, 106], hex: "#BF6A6A", eng: "Dusty Rose", name: "ë¨¼ì§€ ìŒ“ì¸ ì¥ë¯¸ìƒ‰"},
            {no: 141, rgb: [170, 85, 85], hex: "#AA5555", eng: "Indian Red", name: "ì¸ë””ì–¸ ë ˆë“œ"},
            {no: 142, rgb: [212, 85, 128], hex: "#D45580", eng: "Berry", name: "ë² ë¦¬ìƒ‰"},
            {no: 143, rgb: [170, 149, 149], hex: "#AA9595", eng: "Taupe Rose", name: "í† í”„ ë¡œì¦ˆ"},
            {no: 144, rgb: [42, 0, 0], hex: "#2A0000", eng: "Deepest Espresso", name: "ê°€ì¥ ê¹Šì€ ì—ìŠ¤í”„ë ˆì†Œ"},
            {no: 145, rgb: [149, 106, 0], hex: "#956A00", eng: "Raw Umber", name: "ìƒ ì—„ë²„ìƒ‰"}
        ];

        let isZoomedIn = false;
        let showNumbers = true;
        let isShowingOriginal = false;
        let originalImageObj = null; 
        let cachedGridData = null; 
        const BLOCK_SIZE = 25;

        // UI ì´ë²¤íŠ¸ ì²˜ë¦¬
        function updateFileName() {
            const input = document.getElementById('imageInput');
            const nameDisplay = document.getElementById('fileName');
            if (input.files.length > 0) {
                nameDisplay.innerText = input.files[0].name;
            } else {
                nameDisplay.innerText = "ì„ íƒëœ íŒŒì¼ ì—†ìŒ";
            }
        }

        function toggleColorLimitInput() {
            const check = document.getElementById('limitColorsCheck');
            const wrapper = document.getElementById('colorLimitWrapper');
            wrapper.style.display = check.checked ? 'inline-block' : 'none';
        }

        // íŒ¨ë„ ì—¬ë‹«ê¸° ë°©ì‹ ë³€ê²½ (CSS í´ë˜ìŠ¤ë¡œ í† ê¸€)
        function toggleLegend() {
            const legendContainer = document.getElementById('legendContainer');
            const btn = document.getElementById('toggleLegendBtn');
            const legendWrapper = document.getElementById('legendWrapper');

            legendWrapper.classList.toggle('closed');

            if (legendWrapper.classList.contains('closed')) {
                legendContainer.style.display = 'none';
                btn.innerText = 'ğŸ¨ ì»¬ëŸ¬ ëª©ë¡ ì—´ê¸°';
            } else {
                legendContainer.style.display = 'block';
                btn.innerText = 'ğŸ¨ ì»¬ëŸ¬ ëª©ë¡ ë‹«ê¸°';
            }
        }

        function toggleZoom() {
            const canvas = document.getElementById('resultCanvas');
            const btn = document.getElementById('zoomBtn');
            isZoomedIn = !isZoomedIn;
            
            if (isZoomedIn) {
                canvas.classList.add('zoomed-in');
                btn.innerText = 'ğŸ” í™”ë©´ì— ë§ì¶”ê¸°';
            } else {
                canvas.classList.remove('zoomed-in');
                btn.innerText = 'ğŸ” í™•ëŒ€ ë³´ê¸°';
            }
        }

        function toggleNumbers() {
            const btn = document.getElementById('numberBtn');
            showNumbers = !showNumbers;
            btn.innerText = showNumbers ? 'ğŸ”¢ ë²ˆí˜¸ ë„ê¸°' : 'ğŸ”¢ ë²ˆí˜¸ ì¼œê¸°';
            
            if (!isShowingOriginal && cachedGridData) {
                drawCanvasFromCache(); 
            }
        }

        function toggleOriginalView() {
            const btn = document.getElementById('originalViewBtn');
            const numberBtn = document.getElementById('numberBtn');
            isShowingOriginal = !isShowingOriginal;

            if (isShowingOriginal) {
                btn.innerText = 'ğŸ¨ ì‘ì—… ë„ì•ˆ ë³´ê¸°';
                btn.classList.add('active');
                numberBtn.disabled = true;
                numberBtn.style.opacity = '0.5';
                drawOriginalImage();
            } else {
                btn.innerText = 'ğŸ–¼ï¸ ì›ë³¸ ë³´ê¸°';
                btn.classList.remove('active');
                numberBtn.disabled = false;
                numberBtn.style.opacity = '1';
                drawCanvasFromCache();
            }
        }

        // ìœ í‹¸ë¦¬í‹°
        function calculateDistance(rgb1, rgb2) {
            if (!rgb1 || !rgb2) return Infinity;
            return Math.sqrt(Math.pow(rgb1[0] - rgb2[0], 2) + Math.pow(rgb1[1] - rgb2[1], 2) + Math.pow(rgb1[2] - rgb2[2], 2));
        }

        function findClosestDarinThread(targetRgb, threadList) {
            let minDist = Infinity;
            let closestThread = null;
            for (let thread of threadList) {
                if (!thread.rgb) continue; 
                let dist = calculateDistance(targetRgb, thread.rgb);
                if (dist < minDist) {
                    minDist = dist;
                    closestThread = thread;
                }
            }
            return closestThread;
        }

        function getTextColorForBackground(bgRgb) {
            let luminance = (0.299 * bgRgb[0] + 0.587 * bgRgb[1] + 0.114 * bgRgb[2]);
            return luminance > 128 ? '#222222' : '#ffffff';
        }

        function triggerAnimations() {
            const canvasContainer = document.getElementById('canvasContainer');
            const legendWrapper = document.getElementById('legendWrapper');

            canvasContainer.classList.remove('animate-canvas');
            legendWrapper.classList.remove('animate-sidebar');
            void canvasContainer.offsetWidth; 
            void legendWrapper.offsetWidth;
            canvasContainer.classList.add('animate-canvas');
            legendWrapper.classList.add('animate-sidebar');
        }

        function processImage() {
            const fileInput = document.getElementById('imageInput');
            const gridSizeInput = document.getElementById('gridSize');
            const useColorLimit = document.getElementById('limitColorsCheck').checked;
            
            let maxColors = parseInt(document.getElementById('colorLimit').value) || 15;
            if (maxColors < 5) maxColors = 5;
            if (maxColors > 145) maxColors = 145;
            
            if (fileInput.files.length === 0) {
                alert('ğŸ“ ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    originalImageObj = img;

                    document.getElementById('placeholder').style.display = 'none';
                    document.getElementById('resultCanvas').style.display = 'block';
                    document.getElementById('canvasToolbar').style.display = 'flex';
                    
                    isZoomedIn = false;
                    document.getElementById('resultCanvas').classList.remove('zoomed-in');
                    document.getElementById('zoomBtn').innerText = 'ğŸ” í™•ëŒ€ ë³´ê¸°';
                    
                    isShowingOriginal = false;
                    document.getElementById('originalViewBtn').innerText = 'ğŸ–¼ï¸ ì›ë³¸ ë³´ê¸°';
                    document.getElementById('originalViewBtn').classList.remove('active');
                    document.getElementById('numberBtn').disabled = false;
                    document.getElementById('numberBtn').style.opacity = '1';
                    
                    const stitchesWidth = parseInt(gridSizeInput.value);
                    const aspectRatio = img.height / img.width;
                    const stitchesHeight = Math.round(stitchesWidth * aspectRatio);

                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = stitchesWidth;
                    tempCanvas.height = stitchesHeight;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.drawImage(img, 0, 0, stitchesWidth, stitchesHeight);
                    const imgData = tempCtx.getImageData(0, 0, stitchesWidth, stitchesHeight).data;

                    let allowedThreads = darinThreads;

                    if (useColorLimit) {
                        let freqMap = new Map();
                        for (let i = 0; i < imgData.length; i += 4) {
                            let r = imgData[i], g = imgData[i+1], b = imgData[i+2];
                            let closest = findClosestDarinThread([r, g, b], darinThreads);
                            freqMap.set(closest.no, (freqMap.get(closest.no) || 0) + 1);
                        }
                        let sortedFreq = Array.from(freqMap.entries()).sort((a, b) => b[1] - a[1]);
                        let topThreadNos = sortedFreq.slice(0, maxColors).map(entry => entry[0]);
                        allowedThreads = darinThreads.filter(t => topThreadNos.includes(t.no));
                    }

                    const usedThreads = new Map();
                    cachedGridData = {
                        width: stitchesWidth,
                        height: stitchesHeight,
                        cells: []
                    };

                    for (let y = 0; y < stitchesHeight; y++) {
                        for (let x = 0; x < stitchesWidth; x++) {
                            const index = (y * stitchesWidth + x) * 4;
                            const r = imgData[index];
                            const g = imgData[index + 1];
                            const b = imgData[index + 2];
                            
                            const closest = findClosestDarinThread([r, g, b], allowedThreads);
                            if (!usedThreads.has(closest.no)) usedThreads.set(closest.no, closest);
                            
                            cachedGridData.cells.push({ x: x, y: y, thread: closest });
                        }
                    }

                    drawCanvasFromCache();
                    
                    const legendWrapper = document.getElementById('legendWrapper');
                    legendWrapper.style.display = 'flex';
                    document.getElementById('legendContainer').style.display = 'block';
                    legendWrapper.classList.remove('closed'); // PC/ëª¨ë°”ì¼ ìƒê´€ì—†ì´ ìƒˆë¡œ ë§Œë“¤ë©´ ì¼ë‹¨ í¼ì¹¨
                    document.getElementById('toggleLegendBtn').innerText = 'ğŸ¨ ì»¬ëŸ¬ ëª©ë¡ ë‹«ê¸°';
                    
                    renderColorLegend(usedThreads);
                    triggerAnimations();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function drawCanvasFromCache() {
            if (!cachedGridData) return;
            
            const canvas = document.getElementById('resultCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = cachedGridData.width * BLOCK_SIZE;
            canvas.height = cachedGridData.height * BLOCK_SIZE;

            ctx.font = '500 11px Pretendard, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            cachedGridData.cells.forEach(cell => {
                const tRgb = cell.thread.rgb;
                const px = cell.x * BLOCK_SIZE;
                const py = cell.y * BLOCK_SIZE;

                ctx.fillStyle = `rgb(${tRgb[0]}, ${tRgb[1]}, ${tRgb[2]})`;
                ctx.fillRect(px, py, BLOCK_SIZE, BLOCK_SIZE);
                
                ctx.strokeStyle = 'rgba(0,0,0,0.08)';
                ctx.strokeRect(px, py, BLOCK_SIZE, BLOCK_SIZE);
                
                if (showNumbers) {
                    ctx.fillStyle = getTextColorForBackground(tRgb);
                    ctx.fillText(cell.thread.no, px + (BLOCK_SIZE / 2), py + (BLOCK_SIZE / 2) + 1);
                }
            });
        }

        function drawOriginalImage() {
            if (!originalImageObj || !cachedGridData) return;
            
            const canvas = document.getElementById('resultCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = cachedGridData.width * BLOCK_SIZE;
            canvas.height = cachedGridData.height * BLOCK_SIZE;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(originalImageObj, 0, 0, canvas.width, canvas.height);
        }

        function renderColorLegend(usedThreads) {
            const colorListDiv = document.getElementById('colorList');
            const colorCountSpan = document.getElementById('colorCount');
            colorListDiv.innerHTML = '';

            const sortedThreads = Array.from(usedThreads.values()).sort((a, b) => a.no - b.no);
            colorCountSpan.innerText = sortedThreads.length;

            sortedThreads.forEach(thread => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'color-item';

                const colorBox = document.createElement('div');
                colorBox.className = 'color-box';
                if (thread.rgb) {
                    colorBox.style.backgroundColor = thread.hex; 
                } else {
                    colorBox.style.backgroundColor = '#ccc'; 
                }

                const infoDiv = document.createElement('div');
                infoDiv.className = 'color-info';
                
                infoDiv.innerHTML = `
                    <div><span class="color-no">No.${thread.no}</span> ${thread.name}</div>
                    <span class="color-eng">${thread.eng}</span>
                `;

                itemDiv.appendChild(colorBox);
                itemDiv.appendChild(infoDiv);
                colorListDiv.appendChild(itemDiv);
            });
        }
    </script>
</body>
</html>